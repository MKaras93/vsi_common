
. "$(dirname ${BASH_SOURCE[0]})/testlib.sh"
. "$(dirname ${BASH_SOURCE[0]})/test_utils.bsh"

VSI_COMMON_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.."; pwd)"
. "${VSI_COMMON_DIR}/linux/docker_functions.bsh"
. "${VSI_COMMON_DIR}/linux/just_functions.bsh"
. "${VSI_COMMON_DIR}/linux/elements.bsh"

setup()
{
  temp_dir="$(mktemp -d -u)"

  compose_file='version: "3.2"
services:
  nb:
    image: blah
    volumes:
      - /tmp:/mnt
      - test:/opt
  foo:
    image: bar
    volumes:
  bar:
    image: foo
volumes:
  test:'
}

begin_test "Test DOCKER var"
(
  set -eu
  DRYRUN=echo
  DOCKER="DoCkEr"
  [ "$(Docker run test)" = "DoCkEr run --rm test" ]
)
end_test

begin_test "Test NVIDIA_DOCKER var"
(
  set -eu
  DRYRUN=echo
  NVIDIA_DOCKER="NvIdIa-DoCkEr"
  [ "$(Nvidia-docker run test)" = "NvIdIa-DoCkEr run --rm test" ]
)
end_test

begin_test "is_dir_and_not_exist"
(
  set -eu
  not is_dir_and_not_exist qwertyuiop
  not is_dir_and_not_exist /
  is_dir_and_not_exist "$(mktemp -d -u)"
)
end_test

command -v "${DOCKER}" >&/dev/null || skip_next_test
begin_test "container get label"
(
  set -eu

  check_skip

  "${DOCKER}" create -l t1=15 -l "TEST=THIS=t h  a   t" -l blank --name test-docker-function alpine

  [ "$(container_get_label test-docker-function t1)" = "15" ]
  [ "$(container_get_label test-docker-function TEST)" = "THIS=t h  a   t" ]
  [ "$(container_get_label test-docker-function blank)" = "" ]
  [ "$(container_get_label test-docker-function none)" = "" ]

  "${DOCKER}" rm test-docker-function
)
end_test

(command -v "${DOCKER}" >&/dev/null && command -v jq >&/dev/null) || skip_next_test
begin_test "container has label"
(
  set -eu

  check_skip

  "${DOCKER}" create -l t1=15 -l "TEST=THIS=t h  a   t" -l blank --name test-docker-function alpine

  container_has_label test-docker-function t1
  container_has_label test-docker-function TEST
  container_has_label test-docker-function blank
  not container_has_label test-docker-function none

  "${DOCKER}" rm test-docker-function
)
end_test

begin_test "docker_premkdir"
(
  set -eu

  mkdir -p "${temp_dir}"
  cd "${temp_dir}"

  docker_premkdir "${temp_dir}"
  docker_premkdir internal_dir

  touch "${temp_dir}/premkfile"
  docker_premkdir "${temp_dir}/premkfile"
  [ ! -d "${temp_dir}/premkfile" ]
  [ -e "${temp_dir}/premkfile" ]

  [ ! -d "${temp_dir}/premkdir" ]
  docker_premkdir "${temp_dir}/premkdir"
  [ -d "${temp_dir}/premkdir" ]

  rm "${temp_dir}/premkfile"
)
end_test

begin_test "docker host dir"
(
  set -eu

  if [ "${OS-}" = "Windows_NT" ]; then
    [ "$(docker_host_dir /tmp)" = "$(cygpath -w /tmp)" ]
  else
    [ "$(docker_host_dir /tmp)" = "/tmp" ]
  fi
)
end_test

begin_test "Docker volume string parsing"
(
  set -eu

  host_paths=("/foo/bar"
              "/foo/b  ar"
              "D:/foo/bar"
              "D:\foo\bar"
              "vl"
             )

  docker_paths=("/test/this"
                "/te st/th  is"
                "z")
  test_volume_flags=(""
                     ":ro"
                     ":ro:z"
                     ":z:ro"
                     ":Z:rshared:rw:nocopy")

  if docker_parse_volume_string garbage; then
    return 1
  fi

  for host_path in "${host_paths[@]}"; do
    for docker_path in "${docker_paths[@]}"; do
      for test_volume_flag in "${test_volume_flags[@]}"; do
        docker_parse_volume_string "${host_path}:${docker_path}${test_volume_flag}"
        [ "${volume_host}" = "${host_path}" ]
        [ "${volume_docker}" = "${docker_path}" ]
        [ "${volume_flags}" = "${test_volume_flag}" ]
      done
    done
  done
)
end_test

begin_test "Santize Volumes"
(
  set -eu

  temp_dir="${temp_dir}/sv"

  [ ! -e "${temp_dir}" ]

  if [ "${OS-notwindows}" = "Windows_NT" ]; then
    [ "$(docker_sanitize_volume ${temp_dir})" = "$(cygpath -w "${temp_dir}"):/${temp_dir}" ]
    [ "$(docker_sanitize_volume ${temp_dir} /foo)" = "$(cygpath -w "${temp_dir}")://foo" ]
  else
    [ "$(docker_sanitize_volume ${temp_dir})" = "${temp_dir}:${temp_dir}" ]
    [ "$(docker_sanitize_volume ${temp_dir} /bar)" = "${temp_dir}:/bar" ]
  fi

  [ -e "${temp_dir}" ]
)
end_test

begin_test "Parse docker args"
(
  set -eu
  parse-docker --config=blah.json -D -v run -v /foo:/bar debian:9 bash
  a1=(--config=blah.json -D -v)
  a2=(-v /foo:/bar debian:9 bash)
  cmp_elements_a docker_args a1
  [ "${docker_command}" = "run" ]
  cmp_elements_a docker_command_args a2
)
end_test

begin_test "Docker command"
(
  set -eu
  export DRYRUN=print_command

  DOCKER_AUTOREMOVE=0
  a=($DOCKER run -v '/test  this/:blah' 'debian:9')
  r="$(Docker run -v "/test  this/:blah" debian:9)"
  eval "r=($r)"
  cmp_elements_a a r
)
end_test

begin_test "DOCKER_AUTOREMOVE and DOCKER_EXTRA_*_ARGS"
(
  set -eu
  export DRYRUN=print_command

  a=("${DOCKER}" run --rm -v '/test  this/:blah' 'debian:9')
  r="$(Docker run -v "/test  this/:blah" debian:9)"
  eval "r=($r)"
  cmp_elements_a a r

  DOCKER_EXTRA_RUN_ARGS=('aaa' 'bbb')
  a=("${DOCKER}" run --rm aaa bbb -v '/test  this/:blah' 'debian:9')
  r="$(Docker run -v "/test  this/:blah" debian:9)"
  eval "r=($r)"
  cmp_elements_a a r
)
end_test

begin_test "DOCKER_EXTRA_ARGS"
(
  set -eu
  export DRYRUN=print_command

  DOCKER_EXTRA_BUILD_ARGS=('aaa' 'bbb')
  DOCKER_EXTRA_ARGS=(--config bl\ \ ah.json -l=debug -H 123)
  a=("${DOCKER}" --tls "${DOCKER_EXTRA_ARGS[@]}" build aaa bbb -v '/test  this/:blah' 'debian:9')
  r="$(Docker --tls build -v "/test  this/:blah" debian:9)"
  eval "r=($r)"
  cmp_elements_a a r
)
end_test





begin_test "Test DOCKER_COMPOSE var"
(
  set -eu
  DRYRUN=echo
  DOCKER_COMPOSE="DoCkEr-CoMpOsE"
  [ "$(Docker-compose run test)" = "DoCkEr-CoMpOsE run --rm test" ]
)
end_test

begin_test "docker compose parse volumes"
(
  set -eu

  ans=(-v "/tmp:/mnt" -v "test:/opt")
  docker-compose-volumes nb <<< "${compose_file}"
  cmp_elements_a DOCKER_VOLUME_FLAGS ans

  ans=()
  docker-compose-volumes foo <<< "${compose_file}"
  cmp_elements_a DOCKER_VOLUME_FLAGS ans

  docker-compose-volumes bar <<< "${compose_file}"
  cmp_elements_a DOCKER_VOLUME_FLAGS ans

  docker-compose-volumes none <<< "${compose_file}"
  cmp_elements_a DOCKER_VOLUME_FLAGS ans
)
end_test

begin_test "Parse docker-compose args"
(
  set -eu

  parse-docker-compose --no-ansi -H=blah.json --verbose run -v /foo:/bar debian bash
  a1=(--no-ansi -H=blah.json --verbose)
  a2=(-v /foo:/bar debian bash)
  cmp_elements_a docker_compose_args a1
  [ "${docker_compose_command}" = "run" ]
  cmp_elements_a docker_compose_command_args a2
)
end_test


begin_test "Parse docker compose file args"
(
  set -eu
  parse-docker-compose -f test1.yml -ftest2 --file test3 --file=test4 run debian:9 bash
  [ "${#docker_compose_files[@]}" = 4 ]
)
end_test

begin_test "Compose IFS non-Windows"
(
  set -eu
  unset OS
  [ "$(compose_path_separator)" = ":" ]
)
end_test

begin_test "Compose IFS Windows"
(
  set -eu
  OS="Windows_NT"
  [ "$(compose_path_separator)" = ";" ]
)
end_test

begin_test "Custom IFS"
(
  set -eu
  COMPOSE_PATH_SEPARATOR='|'
  OS="Windows_NT"
  [ "$(compose_path_separator)" = "|" ]
  unset OS
  [ "$(compose_path_separator)" = "|" ]
)
end_test

begin_test "Docker-compose command"
(
  set -eu
  export DRYRUN=print_command

  DOCKER_COMPOSE_AUTOREMOVE=0
  a=($DOCKER_COMPOSE run -v '/test  this/:blah' 'debian:9')
  r="$(Docker-compose run -v "/test  this/:blah" debian:9)"
  eval "r=($r)"
  cmp_elements_a a r
)
end_test

begin_test "DOCKER_COMPOSE_AUTOREMOVE and DOCKER_COMPOSE_EXTRA_*_ARGS"
(
  set -eu
  export DRYRUN=print_command

  a=("${DOCKER_COMPOSE}" run --rm -v '/test  this/:blah' 'debian')
  r="$(Docker-compose run -v "/test  this/:blah" debian)"
  eval "r=($r)"
  cmp_elements_a a r

  DOCKER_COMPOSE_EXTRA_RUN_ARGS=('aaa' 'bbb')
  a=("${DOCKER_COMPOSE}" run --rm aaa bbb -v '/test  this/:blah' 'debian')
  r="$(Docker-compose run -v "/test  this/:blah" debian)"
  eval "r=($r)"
  cmp_elements_a a r
)
end_test

begin_test "DOCKER_COMPOSE_EXTRA_ARGS"
(
  set -eu
  export DRYRUN=print_command

  DOCKER_COMPOSE_EXTRA_BUILD_ARGS=('aaa' 'bbb')
  DOCKER_COMPOSE_EXTRA_ARGS=(--config bl\ \ ah.json -l=debug -H 123)
  a=("${DOCKER_COMPOSE}" --tls "${DOCKER_COMPOSE_EXTRA_ARGS[@]}" build aaa bbb -v '/test  this/:blah' 'debian')
  r="$(Docker-compose --tls build -v "/test  this/:blah" debian)"
  eval "r=($r)"
  cmp_elements_a a r
)
end_test

begin_fail_test "docker_service_running"
(
  set -eu
  false
)
end_test

begin_fail_test "docker_compose_service_names"
(
  set -eu
  false todo
)
end_test

begin_test "docker-compose service names"
(
  set -eu
  service_names="$(docker_compose_service_names <(echo "${compose_file}"))"

  ans="nb foo bar"
  cmp_elements service_names ans
)
end_test

begin_test "filter docker variables"
(
  set -eu

  PROJECT_VAR1=15
  VAR2_DOCKER=16
  PROJECT_VAR1_DOCKER=17

  JUST_FILTER_DOCKER=0 filter_docker_variables PROJECT
  [ "${PROJECT_VAR1-}" = "15" ]
  [ "${VAR2_DOCKER-}" = "16" ]
  [ "${PROJECT_VAR1_DOCKER-}" = "17" ]

  filter_docker_variables PROJECT
  [ "${PROJECT_VAR1-}" = "15" ]
  [ "${VAR2_DOCKER-}" = "16" ]
  [ -z "${PROJECT_VAR1_DOCKER+_}" ]
)
end_test

begin_test "Docker compose santize project names"
(
  set -eu

  [ "$(docker_compose_sanitize_project_name 'project/A@1.1_2')" = "a112" ]
  [ "$(docker_compose_sanitize_project_name 'project/A@1.1_2' 'auser:7')" = "auser7a112" ]
  [ "$(docker_compose_sanitize_project_name '' 'a-user:7')" = "auser7" ]
)
end_test

teardown()
(
  ! ${DOCKER} rm test-docker-function &>/dev/null
  ! rm "${temp_dir}/premkfile" &>/dev/null
  #remove all dirs. Trying to be safe here. Will fail if any dir is not empty
  ! find "${temp_dir}" -type d -depth -exec rmdir \{\} \;
)
